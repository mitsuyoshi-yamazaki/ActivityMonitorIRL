# デザインパターン解説

## MVVMパターンの概要

MVVM（Model-View-ViewModel）パターンは、UIアプリケーションにおいて関心の分離を実現するためのアーキテクチャパターンです。Microsoftが2005年にWPF向けに提案したパターンで、宣言的なデータバインディングを持つUIフレームワークに適しています。

### 基本構成要素

#### Model（モデル）
- **役割**: データ構造とビジネスロジックを表現
- **責務**: データの整合性維持、ビジネスルールの実装
- **特徴**: UIに依存しない、再利用可能

#### View（ビュー）
- **役割**: ユーザーインターフェースの表示とユーザー操作の受信
- **責務**: レイアウト、イベントハンドリング、ViewModelへの操作委譲
- **特徴**: 宣言的、ViewModelの状態を観察して自動更新

#### ViewModel（ビューモデル）
- **役割**: ViewとModelの仲介、プレゼンテーション層のロジック
- **責務**: View向けのデータ変換、ユーザー操作の処理、状態管理
- **特徴**: Viewから独立してテスト可能、複数Viewで再利用可能

## SwiftUIにおけるMVVM実装

SwiftUIの`@ObservableObject`と`@Published`プロパティラッパーにより、MVVMパターンの宣言的なデータバインディングが実現されます。

### データフロー

1. **View → ViewModel**: ユーザー操作により ViewModelのメソッド呼び出し
2. **ViewModel → Model**: ビジネスロジック実行、データ変更
3. **Model → ViewModel**: 変更結果を`@Published`プロパティに反映
4. **ViewModel → View**: `@Published`の変更により自動的にView更新

### 各登場人物の具体的役割

#### ObservableObject（ViewModel）
```swift
class DailyActivityViewModel: ObservableObject {
    @Published var records: [Int: ActivityRecord] = [:]
    @Published var selectedDate: Date = Date()
}
```
- `ObservableObject`プロトコルに準拠
- `@Published`で状態変更を通知
- Viewのライフサイクルから独立したビジネスロジック

#### @StateObject / @ObservedObject（View側）
```swift
struct DailyActivityView: View {
    @StateObject private var viewModel = DailyActivityViewModel()
}
```
- `@StateObject`: ViewModelのライフサイクル管理
- `@ObservedObject`: 外部から注入されたViewModelの観察
- `@Published`プロパティの変更を自動検知してView再描画

#### Repository Pattern（データアクセス層）
```swift
class ActivityRepository {
    func save(_ record: ActivityRecord) async throws { }
    func fetch(for date: Date) async throws -> [ActivityRecord] { }
}
```
- ViewModelとデータ永続化層の分離
- テスタビリティとモック化の向上
- 複数のデータソース（SQLite、API等）への対応

## 関連パターンと参考資料

### Observer パターン
MVVMの基盤となるパターン。SwiftUIでは`@Published`と`@ObservedObject`がObserverパターンを実装。

### Repository パターン
データアクセスロジックをカプセル化し、ビジネスロジックから分離するパターン。

### 参考リンク

- [Apple Developer - Managing Model Data in Your App](https://developer.apple.com/documentation/swiftui/managing-model-data-in-your-app)
- [SwiftUI ObservableObject](https://developer.apple.com/documentation/combine/observableobject)
- [MVVM Pattern - Microsoft Docs](https://docs.microsoft.com/en-us/dotnet/architecture/maui/mvvm)
- [Repository Pattern - Martin Fowler](https://martinfowler.com/eaaCatalog/repository.html)
- [Observer Pattern - Gang of Four](https://en.wikipedia.org/wiki/Observer_pattern)

## 本アプリケーションでの実装指針

1. **単一責任**: 各ViewModelは単一画面の状態管理に特化
2. **依存性注入**: RepositoryはViewModelに注入、テスト時にモック化
3. **非同期処理**: async/awaitを使用してメインスレッドをブロックしない
4. **エラーハンドリング**: ViewModelでエラーを捕捉し、適切なUI状態に変換
5. **メモリ管理**: 強参照循環を避けるため`@StateObject`と`@ObservedObject`を適切に使い分け